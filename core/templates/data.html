{% extends "layouts/base.html" %}

{% block title %} Data {% endblock %} 

<!-- Specific Plugin CSS goes HERE -->
{% block plugin_stylesheets %}
<link rel="stylesheet" href="/static/assets/vendors/jvectormap/jquery-jvectormap.css">
<link rel="stylesheet" href="/static/assets/vendors/flag-icon-css/css/flag-icon.min.css">
<link rel="stylesheet" href="/static/assets/vendors/owl-carousel-2/owl.carousel.min.css">
<link rel="stylesheet" href="/static/assets/vendors/owl-carousel-2/owl.theme.default.min.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
{% endblock plugin_stylesheets %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

  <div class="content-wrapper">
    <div class="page-header">
      <h3 class="page-title"> Data </h3>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="#">Tables</a></li>
          <li class="breadcrumb-item active" aria-current="page">Data tables</li>
        </ol>
      </nav>
    </div>



    <div class="row">
      <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
          <div class="card-body">
            <h4 class="card-title">Data Tables</h4>
            </p>

            <form id="fore-bench-form"   class="forms-sample">
                <div class="row">
                  <div class="col-md-6">
                    <label>Location </label>
    
    
    
                    <div class="form-group" id ="forecast">
                      <select   id="select_forecast" onchange='$("#fore-bench-form").submit(update_suggestions())' class="js-example-basic-single col-md-6" name="getforebench">
    
                        <option  value="{{ states.0 }}" selected> {{ states.0 }}</option>
                        {% for st in states|slice:"1:" %}
                        <option value="{{ st }}" > {{ st }}</option>
                        {% endfor %}
    
                      </select>
                    </div>
                  </div>
    
    
    
                  <div class="col-md-6" >
                    <label>Forecast Team - Model</label>
                    <div class="form-group" id="team">
    
                      <select   id="select_bench" onchange='$("#fore-bench-form").submit(update_suggestions())' class="js-example-basic-single col-md-6" name="getforebench">
                        <option  value="{{models.0}}" selected> {{models.0}} </option>
    
                        {% for model in models|slice:'1:' %}
                        <option value="{{ model }}" > {{ model }}</option>
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                </div>
    
    
                <div class="row">
                  <div class="col-md-6" id= targets>
    
    
    
                    <label class="col-sm-4 col-form-label">Target</label>
                    <div class="form-group row" >
    
    
                      <div class="col-sm-4">
                        <div class="form-check">
                          <label class="form-check-label">
                            <input type="radio" checked onchange='$("#fore-bench-form").submit(send_forecastdata_form())' id= "select_type1" class="form-check-input" name="membershipRadios"  value="inc case"> Incident Cases </label>
                          </div>
                        </div>
    
                        <div class="col-sm-5">
                          <div class="form-check">
                            <label class="form-check-label">
                              <input type="radio"  onchange='$("#fore-bench-form").submit(send_forecastdata_form())' id= "select_type2" class="form-check-input" name="membershipRadios"  value="inc death">Incident  Deaths </label>
                            </div>
                          </div>
    
                          <div class="col-sm-4">
                            <div class="form-check">
                              <label class="form-check-label">
                                <input type="radio"  onchange='$("#fore-bench-form").submit(send_forecastdata_form())'  class="form-check-input"  id= "select_type3" name="membershipRadios" value="cum case"> Cumulative Cases</label>
                              </div>
                            </div>
                            <div class="col-sm-5">
                              <div class="form-check">
                                <label class="form-check-label">
                                  <input type="radio" onchange='$("#fore-bench-form").submit(send_forecastdata_form())' id= "select_type4" class="form-check-input" name="membershipRadios"  value="cum death">  Cumulative Deaths </label>
                                </div>
                              </div>
    
    
    
                            </div>
    
                          </div>
    
    
                          <div class="col-md-6" id= targets>
    
                            <div class="form-group row" >
    
                          <div class="col-sm-12" id = "dates">
                            <label>Forecast Date </label>
                            <div class="form-group">
    
                              <select   id="select_date" onchange='$("#fore-bench-form").submit(send_forecastdata_form())' class="js-example-basic-single col-md-6" name="sendate">
                                <option selected value="{{ dates.0 }}" >{{ dates.0}}</option>
    
                                {% for date in dates|slice:'1:'  %}
                                <option  value="{{ date }}" > {{ date }}</option>
                                {% endfor %}
                              </select>
                            </div>
                          </div>
    
                      </div>
    
                      </div>
                    </div>


                    <div class="col-md-6">
                        <h4 class="card-title">Download</h4>
                    <button type="button" onclick="download_data()" class="btn btn-success btn-icon-text">
                        <i class="mdi mdi mdi-download btn-icon-prepend"></i> Dowload dataset </button>
    
                  </div>

                    </form>
                    



                <br>
                <br>
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
            <div class="table-responsive">

                <table class="table" id="excelDataTable">
               
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>

      <script>

     
              
         function ConvertToCSV(objArray) {
            var array = typeof objArray != 'object' ? JSON.parse(objArray) : objArray;
            var str = '';

            for (var i = 0; i < array.length; i++) {
                var line = '';
                for (var index in array[i]) {
                    if (line != '') line += ','

                    line += array[i][index];
                }

                str += line + '\r\n';
            }

            return str;
        }
        function download_data()
        {
          data = ConvertToCSV(_data)
          console.log(data)
          filename = "export.csv"
          csvFile = new Blob([data], {type: "text/csv"});

            // download link
            downloadLink = document.createElement("a");

            // file name
            downloadLink.download = filename;

            // create link to file
            downloadLink.href = window.URL.createObjectURL(csvFile);

            // hide download link
            downloadLink.style.display = "";

            // add link to DOM
            document.body.appendChild(downloadLink);

            // click download link
            downloadLink.click();
        }
        function update_selectors(response, selector_name, response_type)
        {
          x = document.getElementById(selector_name)
          last = x.options[x.selectedIndex].value
          //  last = x.options[0].value
          while (x.options.length > 0) {

            x.remove(x.options.length - 1);
          }

          new_options =  response[response_type]

          console.log("Last SELECTOR for-  ",selector_name,"   - :")
          console.log(last)

          check_last = true
          for (i = 0; i < new_options.length; i++) {


            var opt = document.createElement('option');

            opt.text = new_options[i]
            opt.value = new_options[i]
            if(new_options[i]== last)
            {
              console.log("ENTRA")
              opt.selected = true
              console.log("NEW is", opt.value)
              check_last = false
            }
            x.add(opt, null);
          }

          if(check_last)
          {
            if (x.options[0] == null){
              var opt = document.createElement('option');

              opt.text = "No quantiles"
              opt.value = "-1"
              x.add(opt,null)
              x.options[0].selected = true
            }
            else
            {
              x.options[0].selected = true
            }
          }
        }

        function update_radio (response)
        {
          _radio_filter = response["radio_filter"]
          radio_list = document.forms['fore-bench-form'].elements['membershipRadios']

          for (i = 0; i < radio_list.length; i++)
          {
            for(j = 0 ; j < _radio_filter.length; j++)
            {
              if(radio_list[i].value == _radio_filter[j])
              {
                radio_list[i].disabled = true
                console.log("disattivo",radio_list[i].value )

              }


            }

          }

          _radio_activate = response["radio_activate"]
          radio_list = document.forms['fore-bench-form'].elements['membershipRadios']

          for (i = 0; i < radio_list.length; i++)
          {
            for(j = 0 ; j < _radio_activate.length; j++)
            {
              if(radio_list[i].value == _radio_activate[j])
              {

                radio_list[i].disabled = false
                console.log("attivo",radio_list[i].value )
                radio_list[i].checked  = true

              }


            }

          }
        }

 function update_suggestions()
        {

         var fore = document.getElementById("select_forecast");
         var bench = document.getElementById("select_bench");

         var fore_value = fore.value;
         var bench_value = bench.value;


         console.log("URL:")
         console.log("get/ajax/update_suggestions/"+fore_value+"/"+bench_value)
         $.ajax({
           type: 'GET',
           // get/ajax/fore-bench/ 'code=' + code + '&userid=' + userid
           url: "get/ajax/update_suggestions/"+fore_value+"/"+bench_value,
           data: "",
           success: function (response) {

             console.log("ENTER RESPONSE")
             _err = response["errors"]
             console.log("ACK: "+_err)
             if(_err=="no")
             {


               update_radio(response)

               update_selectors(response,"select_date","dates")

               send_forecastdata_form()
             }

             else {

               $("#error_alert").fadeIn(400);
               setTimeout(function(){
                 $("#error_alert").fadeOut(800);
               }, 3000)



             }




           },
           error: function (response) {
             // alert the error if any error occured






           }
         })
       }

   function remove_table(selector) { 
                  $(selector+ " tr").remove(); 
                
              } 

function buildHtmlTable(selector,myList) {
  var columns = addAllColumnHeaders(myList, selector);

  for (var i = 0; i < myList.length; i++) {
    var row$ = $('<tr/>');
    for (var colIndex = 0; colIndex < columns.length; colIndex++) {
      var cellValue = myList[i][columns[colIndex]];
      if (cellValue == null) cellValue = "";
      row$.append($('<td/>').html(cellValue));
    }
    $(selector).append(row$);
  }
}

// Adds a header row to the table and returns the set of columns.
// Need to do union of keys from all records as some records may not contain
// all records.
function addAllColumnHeaders(myList, selector) {
  var columnSet = [];
  var headerTr$ = $('<tr/>');

  for (var i = 0; i < myList.length; i++) {
    var rowHash = myList[i];
    for (var key in rowHash) {
      if ($.inArray(key, columnSet) == -1) {
        columnSet.push(key);
        headerTr$.append($('<th/>').html(key));
      }
    }
  }
  $(selector).append(headerTr$);

  return columnSet;
}

       
        function send_forecastdata_form() {
          // preventing from page reload and default actions

          // serialize the data for sending the form data.
          var serializedData = $(this).serialize();


          var fore = document.getElementById("select_forecast");
          var bench = document.getElementById("select_bench");
          var type = document.forms['fore-bench-form'].elements['membershipRadios']
          var date = document.getElementById("select_date");

          var fore_value = fore.value;
          var bench_value = bench.value;
          var type_value = type.value;
          var date_value = date.value;

          console.log("URL:")
          console.log("get/ajax/forecast_data/"+fore_value+"/"+bench_value+"/"+type_value+"/"+date_value+"/")
          // make POST ajax call
          $.ajax({
            type: 'GET',
            // get/ajax/fore-bench/ 'code=' + code + '&userid=' + userid
            url: "get/ajax/forecast_data/"+fore_value+"/"+bench_value+"/"+type_value+"/"+date_value+"/",
            data: "",
            success: function (response) {

              console.log("ENTER RESPONSE")
              _err = response["errors"]
              console.log("ACK: "+_err)
              if(_err=="no")
              {


                _name = response["name"]
               _data = response["data"]
               remove_table('#excelDataTable')
               buildHtmlTable('#excelDataTable', myList =_data)


              }
              else if(_err == "No date")
              {

                $("#error_alert").fadeIn(400);
                setTimeout(function(){
                  $("#error_alert").fadeOut(800);
                }, 3000)
              }
              else {

                $("#error_alert").fadeIn(400);
                setTimeout(function(){
                  $("#error_alert").fadeOut(800);
                }, 3000)


              }




            },
            error: function (response) {
              // alert the error if any error occured






            }
          })
        }


      </script>

{% endblock content %}

<!-- Specific Plugin JS goes HERE  -->
{% block plugin_javascripts %}
<script src="/static/assets/vendors/chart.js/Chart.min.js"></script>
<script src="/static/assets/vendors/progressbar.js/progressbar.min.js"></script>
<script src="/static/assets/vendors/jvectormap/jquery-jvectormap.min.js"></script>
<script src="/static/assets/vendors/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
<script src="/static/assets/vendors/owl-carousel-2/owl.carousel.min.js"></script>

<script src="/static/assets/vendors/select2/select2.min.js"></script>
<script src="/static/assets/vendors/typeahead.js/typeahead.bundle.min.js"></script>
{% endblock plugin_javascripts %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="/static/assets/js/chart.js"></script>

<script src="/static/assets/js/dashboard.js"></script>
<script src="/static/assets/js/file-upload.js"></script>
<script src="/static/assets/js/typeahead.js"></script>
<script src="/static/assets/js/select2.js"></script>
<script src="https://code.highcharts.com/highcharts-more.js"></script>
<script src="https://code.highcharts.com/modules/histogram-bellcurve.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
{% endblock javascripts %}
