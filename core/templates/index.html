{% extends "layouts/base.html" %}

{% block title %} Dashboard {% endblock %}

<!-- Specific Plugin CSS goes HERE -->
{% block plugin_stylesheets %}

<!-- Plugin css for this page -->
<link rel="stylesheet" href="/static/assets/vendors/jvectormap/jquery-jvectormap.css">
<link rel="stylesheet" href="/static/assets/vendors/flag-icon-css/css/flag-icon.min.css">
<link rel="stylesheet" href="/static/assets/vendors/owl-carousel-2/owl.carousel.min.css">
<link rel="stylesheet" href="/static/assets/vendors/owl-carousel-2/owl.theme.default.min.css">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

{% endblock plugin_stylesheets %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<div class="content-wrapper">
  <div class="row">
    <div class="col-12 grid-margin stretch-card">
      <div class="card corona-gradient-card">
        <div class="card-body py-0 px-0 px-sm-3">
          <div class="row align-items-center">
            <div class="col-4 col-sm-3 col-xl-2">
              <img src="/static/assets/images/dashboard/Group126@2x.png" class="gradient-corona-img img-fluid" alt="">
            </div>
            <div class="col-5 col-sm-7 col-xl-8 p-0">
              <h4 class="mb-1 mb-sm-0">MAIN PAGE</h4>
            </div>
            <div class="col-3 col-sm-2 col-xl-2 pl-0 text-center">
              <h4 class="mb-1 mb-sm-0">Dashboard</h4>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>






  <div class="row">
    <div class="col-md-12 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Charts Test</h4>


          <form id="fore-bench-form"   class="forms-sample">
            <div class="row">
              <div class="col-md-6">
                <label>Location </label>



                <div class="form-group">
                  <select   id="select_forecast" onchange='$("#fore-bench-form").submit(send_forecast_bench_form())' class="js-example-basic-single col-md-6" name="getforebench">

                    <option  value="{{ states.0 }}" selected> {{ states.0 }}</option>
                    {% for st in states|slice:"1:" %}
                    <option value="{{ st }}" > {{ st }}</option>
                    {% endfor %}

                  </select>
                </div>
              </div>



              <div class="col-md-6">
                <label>Forecast Team </label>
                <div class="form-group">

                  <select   id="select_bench" onchange='$("#fore-bench-form").submit(send_forecast_bench_form())' class="js-example-basic-single col-md-6" name="getforebench">
                    <option  value="{{models.0}}" selected> {{models.0}} </option>

                    {% for model in models|slice:'1:' %}
                    <option value="{{ model }}" > {{ model }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
            </div>


            <div class="row">
              <div class="col-md-6">



                <label class="col-sm-3 col-form-label">Target</label>
                <div class="form-group row">


                  <div class="col-sm-4">
                    <div class="form-check">
                      <label class="form-check-label">
                        <input type="radio" checked onchange='$("#fore-bench-form").submit(send_forecast_bench_form())' id= "select_type1" class="form-check-input" name="membershipRadios"  value="ic"> Incident Cases </label>
                      </div>
                    </div>

                    <div class="col-sm-5">
                      <div class="form-check">
                        <label class="form-check-label">
                          <input type="radio"  onchange='$("#fore-bench-form").submit(send_forecast_bench_form())' id= "select_type2" class="form-check-input" name="membershipRadios"  value="id">Incident  Deaths </label>
                        </div>
                      </div>

                      <div class="col-sm-4">
                        <div class="form-check">
                          <label class="form-check-label">
                            <input type="radio"  onchange='$("#fore-bench-form").submit(send_forecast_bench_form())'  class="form-check-input"  id= "select_type3" name="membershipRadios" value="cc"> Cumulative Cases</label>
                          </div>
                        </div>
                        <div class="col-sm-5">
                          <div class="form-check">
                            <label class="form-check-label">
                              <input type="radio" onchange='$("#fore-bench-form").submit(send_forecast_bench_form())' id= "select_type4" class="form-check-input" name="membershipRadios"  value="cd">  Cumulative Deaths </label>
                            </div>
                          </div>



                        </div>

                      </div>



                      <div class="col-md-6">
                        <label>Forecast Date </label>
                        <div class="form-group">

                          <select   id="select_date" onchange='$("#fore-bench-form").submit(send_forecast_bench_form())' class="js-example-basic-single col-md-4" name="getforebench">
                            <option selected value="{{ dates.0 }}" >{{ dates.0}}</option>

                            {% for date in dates|slice:'1:'  %}
                            <option  value="{{ date }}" > {{ date }}</option>
                            {% endfor %}
                          </select>
                        </div>
                      </div>
                    </div>


                  </form>

                  <div id="container2" style="width:100%; height:400px;"></div>


                  <div class="alert alert-dismissible alert alert-light show fade " id="error_alert" style=" display:none;   position:absolute;
                  top:50%;
                  left:50%;
                  margin-top:-50px;
                  margin-left:-100px;
                  width: 20em" role="alert"  >
                  <strong>Note: </strong>   <br> No forecast release from the last selected team "{{ models.0}}"  <br> Team has been  <strong> automatically selected</strong>
                  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>

                <div class="alert alert-dismissible alert alert-light show fade " style="display:none;  position:absolute;
                top:50%;
                left:50%;
                margin-top:-50px;
                margin-left:-100px;
                width: 20sem" role="alert" id="alert" >
                <strong>Note: </strong>   <br>  No quantiles info for this model!
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>


            </div>



          </div>
        </div>
      </div>




      <script>

        function update_selectors(response)
        {
          x = document.getElementById("select_bench")
          last = x.options[x.selectedIndex].value
          //  last = x.options[0].value
          while (x.options.length > 0) {

            x.remove(x.options.length - 1);
          }

          new_options =  response["models"]

          console.log("LAst")
          console.log(last)

          check_last = true
          for (i = 0; i < new_options.length; i++) {


            var opt = document.createElement('option');

            opt.text = new_options[i]
            opt.value = new_options[i]
            if(new_options[i]== last)
            {
              console.log("ENTRA")
              opt.selected = true
              console.log("NEW is", opt.value)
              check_last = false
            }
            x.add(opt, null);
          }

          if(check_last)
          {
            x.options[0].selected = true
          }
        }

        function update_radio (response)
        {
          _radio_filter = response["radio_filter"]
          radio_list = document.forms['fore-bench-form'].elements['membershipRadios']

          for (i = 0; i < radio_list.length; i++)
          {
            for(j = 0 ; j < _radio_filter.length; j++)
            {
              if(radio_list[i].value == _radio_filter[j])
              {
                radio_list[i].disabled = true
                console.log("disattivo",radio_list[i].value )

              }


            }

          }

          _radio_activate = response["radio_activate"]
          radio_list = document.forms['fore-bench-form'].elements['membershipRadios']

          for (i = 0; i < radio_list.length; i++)
          {
            for(j = 0 ; j < _radio_activate.length; j++)
            {
              if(radio_list[i].value == _radio_activate[j])
              {
                radio_list[i].disabled = false
                console.log("attivo",radio_list[i].value )

              }


            }

          }
        }

        function get_series(labels, values)
        {
          var series = []
          for(var i=0; i<labels.length; ++i) {
            var stringdate = labels[i]
            console.log(stringdate)
            var d = new Date(stringdate).getTime()
            console.log(d)
            series.push([d,values[i]])
          }
          return series
        }


        send_forecast_bench_form()



        function send_forecast_bench_form() {
          // preventing from page reload and default actions

          // serialize the data for sending the form data.
          var serializedData = $(this).serialize();


          var fore = document.getElementById("select_forecast");
          var bench = document.getElementById("select_bench");
          var type = document.forms['fore-bench-form'].elements['membershipRadios']
          var date = document.getElementById("select_date");

          var fore_value = fore.value;
          var bench_value = bench.value;
          var type_value = type.value;
          var date_value = date.value;



          // make POST ajax call
          $.ajax({
            type: 'GET',
            // get/ajax/fore-bench/ 'code=' + code + '&userid=' + userid
            url: "get/ajax/fore-bench/"+fore_value+"/"+bench_value+"/"+type_value+"/"+date_value,
            data: "",
            success: function (response) {

              _err = response["errors"]

              if(_err=="no")
              {




                if(response["quantiles"][0] == -1)
                {
                  _check_quantiles = false

                  $("#alert").fadeIn(400);
                  setTimeout(function(){
                    $("#alert").fadeOut(800);
                  }, 3000)
                  _check_quantiles = true

                }

                update_radio(response)
                update_selectors(response)



              //  _values = response["values"]
                _color = response["color"]
                //   _labels = response["index"]

            //    _values2 = response["values2"]
                _color2 = response["color2"]
                //   _labels2 = response["index2"]

                _name = response["name"]
                _names1 = response["names1"]
                _names2 = response["names2"]
                _models = response["models"]

                /*    console.log("REAL")

                console.log(_labels)
                console.log(_values)

                console.log("FORECAST")
                console.log(_labels2)
                console.log(_values2)

                console.log(_models)
                */

                 _series = response["series"]
                 _series2 = response ["series2"]

                  //  series = get_series(_labels,_values)
                //    series2 = get_series(_labels2,_values2)

                 console.log(_series)
                 console.log(_series2)
                   // console.log(series)
                  //  console.log(series2)


                myChart = Highcharts.chart('container2', {
                  chart: {
                    type: 'spline',
                    zoomType: 'x',
                    backgroundColor: '#191c24',


                  },
                  title: {
                    text: _name,
                    style: {
                      color: '#FFF',
                      font: 'bold'
                    }
                  },
                  yAxis:
                  {
                    gridLineWidth: 0.1
                  },

                  xAxis: {
                    type: 'datetime',
                    gridLineWidth: 0.1,
                    labels: {
                      formatter: function() {
                        return Highcharts.dateFormat('%m/%e/%y', this.value);
                      }
                    }
                  },


                  series: [

                  {
                    name: _names2,
                    data: _series2,
                    color: _color2,

                  },
                  {
                    name: _names1,
                    data: _series,
                    color: _color
                  },
                  ],
                  plotOptions: {
                    line: {
                      dataLabels: {
                        enabled: true
                      }
                    }
                  }
                } );

              }
              else {

                $("#error_alert").fadeIn(400);
                setTimeout(function(){
                  $("#error_alert").fadeOut(800);
                }, 3000)

                update_selectors(response)

                send_forecast_bench_form()


              }




            },
            error: function (response) {
              // alert the error if any error occured






            }
          })
        }




      </script>

  <!--   {% include 'part_template.html' %}  -->

{% endblock content %}

<!-- Specific Plugin JS goes HERE  -->
{% block plugin_javascripts %}
<script src="/static/assets/vendors/chart.js/Chart.min.js"></script>
<script src="/static/assets/vendors/progressbar.js/progressbar.min.js"></script>
<script src="/static/assets/vendors/jvectormap/jquery-jvectormap.min.js"></script>
<script src="/static/assets/vendors/jvectormap/jquery-jvectormap-world-mill-en.js"></script>
<script src="/static/assets/vendors/owl-carousel-2/owl.carousel.min.js"></script>

<script src="/static/assets/vendors/select2/select2.min.js"></script>
<script src="/static/assets/vendors/typeahead.js/typeahead.bundle.min.js"></script>
{% endblock plugin_javascripts %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<script src="/static/assets/js/chart.js"></script>

<script src="/static/assets/js/dashboard.js"></script>
<script src="/static/assets/js/file-upload.js"></script>
<script src="/static/assets/js/typeahead.js"></script>
<script src="/static/assets/js/select2.js"></script>
{% endblock javascripts %}
